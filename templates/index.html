<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Grammar Checker</title>

  <!-- Google Font + Bootstrap CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Office.js MUST load before any Office/Word API calls -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .container {
      background-color: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      padding: 40px 32px;
      width: 100%;
      max-width: 600px;
      animation: fadeIn 0.5s ease-in-out;
      text-align: center;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    h2 {
      color: #4e54c8;
      font-weight: 600;
      font-size: 28px;
      margin-bottom: 18px;
    }
    textarea {
      width: 100%;
      border-radius: 10px;
      padding: 12px;
      border: 2px dashed #8f94fb;
      resize: vertical;
      background-color: #f7f8ff;
      font-size: 14px;
      min-height: 150px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      border: none;
      border-radius: 10px;
      padding: 12px 28px;
      font-weight: 600;
      font-size: 16px;
      width: 100%;
      margin-top: 15px;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #5d63e2, #9da2ff);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    footer {
      margin-top: 25px;
      font-size: 12px;
      color: #777;
    }
    .suggestion {
      margin: 8px 0;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-left: 4px solid #d13438;
      border-radius: 8px;
      text-align: left;
      background: #fff;
    }
    .suggestion b { color: #d13438; }
    .suggestion .arrow { color: #4e54c8; font-weight: 600; }

    /* Spinner */
    #spinner {
      display: none;
      margin: 16px auto;
      width: 32px; height: 32px;
      border: 4px solid #e0e0e0;
      border-top-color: #4e54c8;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error box */
    #errorBox {
      display: none;
      margin-top: 12px;
      padding: 10px 14px;
      background: #fdf3f4;
      border: 1px solid #f4b8bb;
      border-radius: 8px;
      color: #d13438;
      font-size: 13px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚ú® AI Grammar Checker</h2>
    <p>Click the button below to check your Word document for grammar issues.</p>

    <!-- Textarea to preview document text -->
    <textarea id="textArea" placeholder="Your document text will appear here..." readonly></textarea>

    <!-- Check button -->
    <button id="refreshBtn" class="btn btn-primary">üîç Check Grammar</button>

    <!-- Spinner -->
    <div id="spinner"></div>

    <!-- Error box -->
    <div id="errorBox"></div>

    <!-- Suggestions area -->
    <div id="suggestionsBox" class="mt-3"></div>

    <footer>Powered by LanguageTool + Groq + Flask | ¬© 2026</footer>
  </div>

  <script>
    // ‚úÖ FIX 1: Correct backend URL ‚Äî no more dead ngrok link
    const BACKEND = "https://grammar-web-app-10wj.onrender.com";

    Office.onReady(function(info) {
      const refreshBtn    = document.getElementById("refreshBtn");
      const textArea      = document.getElementById("textArea");
      const suggestionsBox = document.getElementById("suggestionsBox");
      const spinner       = document.getElementById("spinner");
      const errorBox      = document.getElementById("errorBox");

      refreshBtn.onclick = async function() {
        // Reset UI
        suggestionsBox.innerHTML = "";
        errorBox.style.display = "none";
        spinner.style.display = "block";
        refreshBtn.disabled = true;

        try {
          // Step 1: Get text from Word document
          let documentText = "";
          await Word.run(async (context) => {
            const body = context.document.body;
            body.load("text");
            await context.sync();
            documentText = body.text.trim();
          });

          if (!documentText) {
            showError("No text found in the document. Please type something first.");
            return;
          }

          // Show text in textarea
          textArea.value = documentText;

          // Step 2: Send to Flask backend
          const response = await fetch(`${BACKEND}/check_grammar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: documentText, mode: "word" })
          });

          if (!response.ok) {
            throw new Error(`Server responded with status ${response.status}`);
          }

          const data = await response.json();

          // ‚úÖ FIX 2: Flask returns HTML string, not a JSON array
          // Parse the HTML to extract grammar-wrong spans
          const suggestions = parseFlaskHTML(data.suggestions || "");

          spinner.style.display = "none";
          refreshBtn.disabled = false;

          // Step 3: Render suggestions
          suggestionsBox.innerHTML = "";

          if (suggestions.length === 0) {
            suggestionsBox.innerHTML = `
              <div style="margin-top:16px; color:#107c10; font-weight:600;">
                ‚úÖ No grammar issues found! Your text looks great.
              </div>`;
            return;
          }

          suggestionsBox.innerHTML = `<p style="margin-top:12px; font-weight:600; color:#4e54c8;">
            ${suggestions.length} issue${suggestions.length !== 1 ? "s" : ""} found:</p>`;

          suggestions.forEach(s => {
            const div = document.createElement("div");
            div.className = "suggestion";
            div.innerHTML = `
              <p style="margin:0 0 6px">
                <b>${escapeHtml(s.wrong)}</b>
                <span class="arrow"> ‚ûù </span>
                ${escapeHtml(s.suggestion)}
                ${s.meaning ? `<br><small style="color:#777;font-style:italic">${escapeHtml(s.meaning)}</small>` : ""}
              </p>
              <button class="btn btn-sm btn-success">‚úì Accept</button>
              <button class="btn btn-sm btn-outline-secondary ms-2">‚úï Ignore</button>
            `;
            // Accept button
            div.querySelectorAll("button")[0].onclick = () => {
              applySuggestion(s.wrong, s.suggestion);
              div.style.opacity = "0";
              setTimeout(() => div.remove(), 200);
            };
            // Ignore button
            div.querySelectorAll("button")[1].onclick = () => {
              div.style.opacity = "0";
              setTimeout(() => div.remove(), 200);
            };
            suggestionsBox.appendChild(div);
          });

        } catch (err) {
          showError(`Could not connect to the grammar server. Please try again.\n\n${err.message}`);
          console.error(err);
        }
      };

      function showError(msg) {
        spinner.style.display = "none";
        refreshBtn.disabled = false;
        errorBox.style.display = "block";
        errorBox.textContent = msg;
      }
    });

    // ‚úÖ FIX 3: Parse Flask's HTML response correctly
    // Flask returns: <span class='grammar-wrong' data-wrong='' data-groq='' data-black='' data-meaning=''>word</span>
    function parseFlaskHTML(html) {
      if (!html) return [];
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const spans = doc.querySelectorAll(".grammar-wrong");
      const results = [];
      spans.forEach(span => {
        const wrong      = (span.getAttribute("data-wrong")   || span.textContent).trim();
        const groq       = (span.getAttribute("data-groq")    || "").trim();
        const black      = (span.getAttribute("data-black")   || "").trim();
        const meaning    = (span.getAttribute("data-meaning") || "").trim();
        const suggestion = groq || black; // prefer groq, fallback to black law term
        if (wrong && suggestion && wrong.toLowerCase() !== suggestion.toLowerCase()) {
          results.push({ wrong, suggestion, meaning });
        }
      });
      return results;
    }

    // Accept suggestion: find and replace text in Word document
    function applySuggestion(oldText, newText) {
      Word.run(async (context) => {
        const body = context.document.body;
        const searchResults = body.search(oldText, { matchCase: false, matchWholeWord: true });
        searchResults.load("items");
        await context.sync();
        if (searchResults.items.length > 0) {
          searchResults.items[0].insertText(newText, Word.InsertLocation.replace);
          await context.sync();
        }
      }).catch(err => console.error("Apply suggestion error:", err));
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
