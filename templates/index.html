<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Grammar Checker</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      min-height: 100vh;
      display: flex; align-items: center;
      justify-content: center; padding: 15px;
    }
    .container {
      background: #ffffff; border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      padding: 30px 28px; width: 100%; max-width: 520px; text-align: center;
    }
    h2 { color: #4e54c8; font-weight: 600; font-size: 24px; margin-bottom: 8px; }
    p.subtitle { color: #555; font-size: 13px; margin-bottom: 0; }

    textarea {
      width: 100%; border-radius: 10px; padding: 12px;
      border: 2px dashed #8f94fb; resize: vertical;
      background-color: #f7f8ff; font-size: 13px; min-height: 130px;
    }
    input[type="file"] {
      border: 2px dashed #8f94fb; border-radius: 10px;
      padding: 10px; background-color: #f7f8ff; cursor: pointer; width: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      border: none; border-radius: 10px; padding: 11px 16px;
      font-weight: 600; font-size: 15px; width: 100%;
    }
    .btn-secondary {
      border-radius: 10px; padding: 9px 16px; width: 100%; margin-top: 8px;
    }
    .or-divider { margin: 14px 0; font-weight: 600; color: #666; font-size: 12px; }
    footer { margin-top: 16px; font-size: 11px; color: #777; }

    /* â”€â”€ Office status bar â”€â”€ */
    #officeStatus {
      display: none; font-size: 12px; padding: 6px 12px;
      border-radius: 8px; margin-bottom: 10px; font-weight: 600;
    }
    #officeStatus.connected    { background:#d4edda; color:#155724; display:block; }
    #officeStatus.disconnected { background:#fff3cd; color:#856404; display:block; }

    /* â”€â”€ Page Navigator â”€â”€ */
    #pageNav {
      display: none;
      background: #f0f0ff; border: 1px solid #c0c0f0;
      border-radius: 12px; padding: 10px 14px; margin: 10px 0;
    }
    #pageNav .nav-title {
      font-size: 11px; font-weight: 600; color: #4e54c8;
      text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px;
    }
    .page-controls {
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-page {
      background: #4e54c8; color: white; border: none;
      border-radius: 8px; padding: 6px 14px; font-size: 12px;
      font-weight: 600; cursor: pointer; transition: background .2s;
    }
    .btn-page:hover:not(:disabled) { background: #3a3fa0; }
    .btn-page:disabled { background: #b0b0d0; cursor: not-allowed; }
    #pageIndicator {
      font-size: 13px; font-weight: 600; color: #333;
      min-width: 80px; text-align: center;
    }
    #pageCharCount {
      font-size: 10px; color: #888; margin-top: 5px;
    }
    /* Progress dots */
    #pageDots {
      display: flex; justify-content: center;
      flex-wrap: wrap; gap: 4px; margin-top: 8px;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #c0c0e0; cursor: pointer;
      transition: background .2s, transform .15s;
    }
    .dot.active    { background: #4e54c8; transform: scale(1.3); }
    .dot.checked   { background: #28a745; }
    .dot:hover     { background: #8f94fb; }

    /* Char limit warning */
    #charWarning {
      display: none; font-size: 11px; color: #856404;
      background: #fff3cd; border-radius: 6px; padding: 4px 8px; margin-top: 4px;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>âœ¨ AI Grammar Checker</h2>
  <p class="subtitle">Legal document checker â€” page by page</p>

  <!-- Office connection status -->
  <div id="officeStatus"></div>

  <form action="/" method="post" enctype="multipart/form-data" class="mt-2">

    <div class="mb-2 text-start">
      <label class="form-label" style="font-size:13px;"><b>Mode</b></label>
      <select class="form-select form-select-sm" name="mode" id="modeSelect">
        <option value="word" selected>Word Mode â€” Highlight + Suggestions</option>
        <option value="rewrite">Full Rewrite Mode â€” Fix tenses, grammar, spelling</option>
      </select>
    </div>

    <!-- â”€â”€ PAGE NAVIGATOR (shown after Refresh) â”€â”€ -->
    <div id="pageNav">
      <div class="nav-title">ğŸ“„ Document Pages</div>
      <div class="page-controls">
        <button type="button" class="btn-page" id="btnPrev" onclick="goToPage(currentPage - 1)" disabled>â† Prev</button>
        <span id="pageIndicator">Page 1 of 1</span>
        <button type="button" class="btn-page" id="btnNext" onclick="goToPage(currentPage + 1)" disabled>Next â†’</button>
      </div>
      <div id="pageCharCount"></div>
      <div id="pageDots"></div>
    </div>

    <textarea id="textBox" name="text" rows="6"
      placeholder="Click 'Refresh from Word' to load your document page by page..."></textarea>

    <div id="charWarning">âš ï¸ This page is long. Consider splitting further for best results.</div>

    <!-- Refresh button -->
    <button type="button" class="btn btn-secondary" id="btnRefresh" onclick="refreshText()">
      ğŸ”„ Refresh from Word
    </button>

    <button type="button" class="btn btn-secondary" onclick="generateMistakeParagraph()">
      ğŸ§ª Generate Sample with Mistakes
    </button>

    <div class="or-divider">â”€â”€ OR upload a .docx file â”€â”€</div>
    <input type="file" name="file" accept=".docx" class="mb-3">

    <button type="submit" class="btn btn-primary">âœ… Check Grammar</button>
  </form>

  <footer>Powered by LanguageTool + Groq + Flask | Â© 2026</footer>
</div>

<script>
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let isInsideWordTaskpane = false;
  let pages        = [];      // array of page text strings
  let currentPage  = 0;       // 0-based index
  let checkedPages = new Set(); // track which pages have been checked

  const CHAR_WARN_LIMIT = 1800; // warn if page > this many chars

  // â”€â”€ postMessage listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('message', function(event) {

    // Office connected
    if (event.data && event.data.type === 'OFFICE_READY') {
      isInsideWordTaskpane = true;
      const s = document.getElementById('officeStatus');
      s.textContent = 'âœ… Connected to Microsoft Word';
      s.className = 'connected';
    }

    // Received pages array from taskpane.html
    if (event.data && event.data.type === 'DOCUMENT_PAGES') {
      pages = event.data.pages || [];
      currentPage = 0;
      checkedPages.clear();

      const btn = document.getElementById('btnRefresh');
      btn.textContent = 'ğŸ”„ Refresh from Word';
      btn.disabled = false;

      if (pages.length === 0) {
        setStatus('âš ï¸ Document appears to be empty.', 'disconnected');
        return;
      }

      // Show navigator
      document.getElementById('pageNav').style.display = 'block';
      buildDots();
      goToPage(0);

      setStatus(`âœ… Loaded ${pages.length} page(s) from document.`, 'connected');
    }

    // Error
    if (event.data && event.data.type === 'ERROR') {
      alert('Word Error: ' + event.data.message);
      document.getElementById('btnRefresh').disabled = false;
    }
  });

  // â”€â”€ Go to a specific page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function goToPage(index) {
    if (index < 0 || index >= pages.length) return;
    currentPage = index;

    // Load page text into textarea
    document.getElementById('textBox').value = pages[index];

    // Update indicator
    document.getElementById('pageIndicator').textContent =
      `Page ${index + 1} of ${pages.length}`;

    // Update char count
    const len = pages[index].length;
    document.getElementById('pageCharCount').textContent =
      `${len} characters on this page`;

    // Char warning
    const warn = document.getElementById('charWarning');
    warn.style.display = len > CHAR_WARN_LIMIT ? 'block' : 'none';

    // Enable/disable prev-next
    document.getElementById('btnPrev').disabled = index === 0;
    document.getElementById('btnNext').disabled = index === pages.length - 1;

    // Update dots
    updateDots();
  }

  // â”€â”€ Build page dots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildDots() {
    const dotsEl = document.getElementById('pageDots');
    dotsEl.innerHTML = '';
    // Only show dots if 20 pages or fewer (avoid overflow)
    if (pages.length > 20) {
      dotsEl.innerHTML = `<span style="font-size:10px;color:#888;">${pages.length} pages loaded</span>`;
      return;
    }
    pages.forEach((_, i) => {
      const dot = document.createElement('div');
      dot.className = 'dot';
      dot.title = `Page ${i + 1}`;
      dot.onclick = () => goToPage(i);
      dotsEl.appendChild(dot);
    });
  }

  // â”€â”€ Update dot states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateDots() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, i) => {
      dot.className = 'dot';
      if (i === currentPage)      dot.classList.add('active');
      else if (checkedPages.has(i)) dot.classList.add('checked');
    });
  }

  // â”€â”€ Mark current page as checked (called when form submits) â”€â”€â”€â”€â”€â”€
  document.querySelector('form').addEventListener('submit', function() {
    checkedPages.add(currentPage);
    // Store current page index in a hidden field so Flask knows which page
    const input = document.createElement('input');
    input.type  = 'hidden';
    input.name  = 'page_index';
    input.value = currentPage;
    this.appendChild(input);
  });

  // â”€â”€ Refresh: ask taskpane.html to read the Word document â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function refreshText() {
    if (!isInsideWordTaskpane) {
      alert('Not running inside a Word taskpane.\nOpen this via the Word Add-in sidebar.');
      return;
    }
    const btn = document.getElementById('btnRefresh');
    btn.textContent = 'â³ Loading pages...';
    btn.disabled = true;
    pages = [];
    checkedPages.clear();
    document.getElementById('pageNav').style.display = 'none';
    window.parent.postMessage({ type: 'READ_DOCUMENT' }, '*');
  }

  // â”€â”€ Generate sample paragraph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateMistakeParagraph() {
    const topic = prompt("Topic? (e.g., court case, contract dispute)", "court case");
    const form = new FormData();
    form.append("topic", topic || "court case");
    try {
      const res  = await fetch("/generate_sample", { method: "POST", body: form });
      const data = await res.json();
      document.getElementById("textBox").value = data.text || "";
      // Hide page nav when using generated text
      document.getElementById('pageNav').style.display = 'none';
      pages = [];
    } catch(e) {
      alert("Could not generate paragraph: " + e.message);
    }
  }

  // â”€â”€ Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(msg, cls) {
    const s = document.getElementById('officeStatus');
    s.textContent = msg;
    s.className = cls;
  }
</script>
</body>
</html>
